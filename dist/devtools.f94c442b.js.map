{"version":3,"sources":["js/lib/API.js","js/devtools.js"],"names":["EVENT","INJECT","DETACH","TEST","LOG_BLOB","LOG_INIT","LOG_STOP","PAGES","CONTENT","DEVTOOL","APIServer","constructor","name","_bus","undefined","_pool","_flow","_messageId","connect","chrome","runtime","onMessage","addListener","_onMessage","bind","close","disconnect","_answerFlow","data","answer","_newData","type","id","target","sender","postMessage","resolver","console","warn","error","reject","resolve","onFlow","callback","offFlow","send","Error","Promise","api","contex","injectionStatus","isCapture","pingTimeout","isAttached","getStatus","then","e","status","_logsCallback","serverIsDetached","clearInterval","detach","startPingout","setTimeout","_onBlobReached","blob","startCaptureLogs","limit","logType","allow","log","stopCaptureLogs","supress","debug","emit","tryConnect","tabId","devtools","inspectedWindow","scriptToInject","isDebugable","devApi","_onPanelShow","panelContext","PANEL_API","init","_onPanelHide","panels","create","panel","onShown","onHidden"],"mappings":"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","file":"devtools.f94c442b.js","sourceRoot":"..\\src","sourcesContent":["export const EVENT = {\r\n\tINJECT: 'inject',\r\n\tDETACH: 'detach',\r\n\tTEST: 'test',\r\n\tLOG_BLOB: 'log',\r\n\tLOG_INIT: 'log-init',\r\n\tLOG_STOP: 'log-stop', \r\n};\r\n\r\nexport const PAGES = {\r\n\tCONTENT: 'content-page',\r\n\tDEVTOOL: 'devtools-page'\r\n}\r\n\r\nexport class APIServer {\r\n\tconstructor(name) {\r\n\t\tthis.name = name;\r\n\t\tthis._bus = undefined;\r\n\t\tthis._pool = {};\r\n\t\tthis._flow = {};\r\n\t\tthis._messageId = 0;\r\n\t}\r\n\r\n\tconnect() {\r\n\t\tthis._bus = chrome.runtime.connect({\r\n\t\t\tname: this.name,\r\n\t\t});\r\n\r\n\t\tthis._bus.onMessage.addListener(this._onMessage.bind(this));\r\n\t}\r\n\r\n\tclose() {\r\n\t\tthis._bus && this._bus.disconnect();\r\n\t\tthis._bus = undefined;\r\n\t}\r\n\r\n\t/**\r\n\t * \r\n\t * @param {any} data\r\n\t * @returns {{answer: Function}} \r\n\t */\r\n\t_answerFlow(data) {\r\n\t\tdata.answer = (_newData = {}) =>{\r\n\t\t\t_newData.type = data.type;\r\n\t\t\t_newData.id = data.id;\r\n\t\t\t_newData.target = data.sender;\r\n\t\t\tthis._bus.postMessage(_newData);\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\t\r\n\t_onMessage(data) {\r\n\t\tconst resolver = this._pool[data.id];\r\n\t\tthis._pool[data.id] = undefined;\r\n\r\n\t\tif (!resolver) {\r\n\t\t\tif (this._flow[data.type]) {\r\n\t\t\t\tthis._flow[data.type](this._answerFlow(data));\r\n\t\t\t} else {\r\n\t\t\t\tconsole.warn(\"message resolve not found\", data.id, data.type);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (data.error) {\r\n\t\t\t\tresolver.reject(data.error);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tresolver.resolve(data);\r\n\t\t}\r\n\t}\r\n\r\n\tonFlow(type, callback) {\r\n\t\tthis._flow[type] = callback;\r\n\t}\r\n\r\n\toffFlow(type) {\r\n\t\tthis._flow[type] = false;\r\n\t}\r\n\r\n\tasync send(type, data) {\r\n\t\tif (!this._bus) {\r\n\t\t\tthrow new Error(\"Connection not opened!\");\r\n\t\t}\r\n\r\n\t\tdata.type = type;\r\n\t\tdata.id = this._messageId++;\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis._pool[data.id] = {\r\n\t\t\t\tid: data.id,\r\n\t\t\t\tresolve,\r\n\t\t\t\treject,\r\n\t\t\t};\r\n\r\n\t\t\tthis._bus.postMessage(data);\r\n\t\t});\r\n\t}\r\n}\r\n","//@ts-check\r\n\r\nimport { EVENT, APIServer, PAGES } from \"./lib/API.js\";\r\n\r\nconst api = new APIServer(PAGES.DEVTOOL);\r\n\r\n/**\r\n * @type {IPanelAPI}\r\n */\r\nlet contex = undefined;\r\nlet injectionStatus = false;\r\nlet isCapture = false;\r\nlet pingTimeout = undefined;\r\nlet isAttached =  false;\r\n\r\nasync function getStatus() {\r\n\tif (!injectionStatus) {\r\n\t\treturn false;\r\n\t}\r\n\r\n\treturn api.send(EVENT.TEST, { target: PAGES.CONTENT }).then((e) => {\r\n\t\treturn e.status;\r\n\t});\r\n}\r\n\r\nlet _logsCallback = undefined;\r\n\r\nfunction serverIsDetached() {\r\n\tclearInterval(pingTimeout);\r\n\r\n\tisCapture = false;\r\n\tisAttached = false;\r\n\tcontex && contex.detach();\r\n\r\n\tconsole.warn(\"AWAY DEV server is detached!\");\r\n}\r\n\r\nfunction startPingout() {\r\n\tpingTimeout = setTimeout(()=>{\r\n\t\tserverIsDetached();\r\n\t}, 1000);\r\n\r\n\tgetStatus().then((status)=>{\r\n\t\tclearInterval(pingTimeout);\r\n\r\n\t\tif(!status) {\r\n\t\t\tserverIsDetached();\r\n\t\t} else {\r\n\t\t\tpingTimeout = setTimeout(()=>{\r\n\t\t\t\tstartPingout();\r\n\t\t\t}, 500)\r\n\t\t}\r\n\t})\r\n}\r\n\r\nfunction _onBlobReached(data) {\r\n\tif (_logsCallback) {\r\n\t\t// пинаем, что не зависили!\r\n\t\tdata.answer({});\r\n\t\t_logsCallback(data.blob);\r\n\t}\r\n}\r\n\r\nfunction startCaptureLogs({ type, limit = 500000 }, callback) {\r\n\t_logsCallback = callback;\r\n\r\n\treturn api.send(EVENT.LOG_INIT, {\r\n\t\tlogType: type,\r\n\t\tlimit,\r\n\t\ttarget: PAGES.CONTENT,\r\n\t}).then(({allow}) => {\r\n\t\tif(allow){\r\n\t\t\tconsole.log(\"register blob flow\");\r\n\r\n\t\t\tapi.onFlow(EVENT.LOG_STOP, () => stopCaptureLogs(true));\r\n\t\t\tapi.onFlow(EVENT.LOG_BLOB, _onBlobReached);\r\n\t\t}\r\n\t\tisCapture = allow;\r\n\r\n\t\treturn allow;\r\n\t});\r\n}\r\n\r\nfunction stopCaptureLogs(supress = false) {\r\n\tif (!isCapture) {\r\n\t\treturn;\r\n\t}\r\n\r\n\tisCapture = false;\r\n\r\n\tconsole.debug(\"DEVTOOL\", \"STOP CAPTURE\");\r\n\r\n\tapi.offFlow(EVENT.LOG_BLOB);\r\n\r\n\tif (!supress) {\r\n\t\tapi.send(EVENT.LOG_STOP, { target: PAGES.CONTENT });\r\n\t}\r\n\r\n\tcontex.emit(EVENT.LOG_STOP, {});\r\n\t_logsCallback = undefined;\r\n}\r\n\r\nasync function tryConnect() {\r\n\tconst status = await api.send(EVENT.INJECT, {\r\n\t\ttabId: chrome.devtools.inspectedWindow.tabId,\r\n\t\tscriptToInject: \"js/content.js\",\r\n\t});\r\n\r\n\tinjectionStatus = status.status;\r\n\r\n\tconst isDebugable = await getStatus();\r\n\r\n\tisAttached = status.status && isDebugable;\r\n\r\n\tif(isAttached) {\r\n\t\tstartPingout();\r\n\t}\r\n\r\n\treturn isAttached;\r\n}\r\n\r\n/**\r\n * @type {IDevToolAPI}\r\n */\r\nconst devApi = {\r\n\tgetStatus,\r\n\tstartCaptureLogs,\r\n\tstopCaptureLogs,\r\n\ttryConnect\r\n};\r\n\r\nfunction _onPanelShow(panelContext) {\r\n\tsetTimeout(() => {\r\n\t\tcontex = panelContext.PANEL_API;\r\n\t\tconsole.log(panelContext);\r\n\t\tapi.connect();\r\n\r\n\t\ttryConnect().then((status)=>{\r\n\t\t\tcontex.init(devApi);\r\n\t\t});\r\n\r\n\t}, 100);\r\n}\r\n\r\nfunction _onPanelHide(panelContext) {\r\n\tcontex = undefined;\r\n\tapi.send(EVENT.DETACH, { target: PAGES.CONTENT });\r\n\tapi.close();\r\n}\r\n\r\nchrome.devtools.panels.create(\r\n\t\"AwayFL\",\r\n\t\"/gfx/icon16.png\",\r\n\t\"panel.html\",\r\n\t(panel) => {\r\n\t\tpanel.onShown.addListener(_onPanelShow);\r\n\t\tpanel.onHidden.addListener(_onPanelHide);\r\n\t}\r\n);\r\n"]}