{"version":3,"sources":["js/lib/API.js","js/background.js"],"names":["EVENT","INJECT","DETACH","TEST","LOG_BLOB","LOG_INIT","LOG_STOP","PAGES","CONTENT","DEVTOOL","APIServer","constructor","name","_bus","undefined","_pool","_flow","_messageId","connect","chrome","runtime","onMessage","addListener","_onMessage","bind","close","disconnect","_answerFlow","data","answer","_newData","type","id","target","sender","postMessage","resolver","console","warn","error","reject","resolve","onFlow","callback","offFlow","send","Error","Promise","_BUSSES","_injectRequestId","message","log","scriptToInject","tabs","executeScript","tabId","file","debug","port","onConnect","onDisconnect","removeListener"],"mappings":"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","file":"background.js","sourceRoot":"..\\src","sourcesContent":["export const EVENT = {\r\n\tINJECT: 'inject',\r\n\tDETACH: 'detach',\r\n\tTEST: 'test',\r\n\tLOG_BLOB: 'log',\r\n\tLOG_INIT: 'log-init',\r\n\tLOG_STOP: 'log-stop', \r\n};\r\n\r\nexport const PAGES = {\r\n\tCONTENT: 'content-page',\r\n\tDEVTOOL: 'devtools-page'\r\n}\r\n\r\nexport class APIServer {\r\n\tconstructor(name) {\r\n\t\tthis.name = name;\r\n\t\tthis._bus = undefined;\r\n\t\tthis._pool = {};\r\n\t\tthis._flow = {};\r\n\t\tthis._messageId = 0;\r\n\t}\r\n\r\n\tconnect() {\r\n\t\tthis._bus = chrome.runtime.connect({\r\n\t\t\tname: this.name,\r\n\t\t});\r\n\r\n\t\tthis._bus.onMessage.addListener(this._onMessage.bind(this));\r\n\t}\r\n\r\n\tclose() {\r\n\t\tthis._bus && this._bus.disconnect();\r\n\t\tthis._bus = undefined;\r\n\t}\r\n\r\n\t/**\r\n\t * \r\n\t * @param {any} data\r\n\t * @returns {{answer: Function}} \r\n\t */\r\n\t_answerFlow(data) {\r\n\t\tdata.answer = (_newData = {}) =>{\r\n\t\t\t_newData.type = data.type;\r\n\t\t\t_newData.id = data.id;\r\n\t\t\t_newData.target = data.sender;\r\n\t\t\tthis._bus.postMessage(_newData);\r\n\t\t}\r\n\t\treturn data;\r\n\t}\r\n\t\r\n\t_onMessage(data) {\r\n\t\tconst resolver = this._pool[data.id];\r\n\t\tthis._pool[data.id] = undefined;\r\n\r\n\t\tif (!resolver) {\r\n\t\t\tif (this._flow[data.type]) {\r\n\t\t\t\tthis._flow[data.type](this._answerFlow(data));\r\n\t\t\t} else {\r\n\t\t\t\tconsole.warn(\"message resolve not found\", data.id, data.type);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tif (data.error) {\r\n\t\t\t\tresolver.reject(data.error);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tresolver.resolve(data);\r\n\t\t}\r\n\t}\r\n\r\n\tonFlow(type, callback) {\r\n\t\tthis._flow[type] = callback;\r\n\t}\r\n\r\n\toffFlow(type) {\r\n\t\tthis._flow[type] = false;\r\n\t}\r\n\r\n\tasync send(type, data) {\r\n\t\tif (!this._bus) {\r\n\t\t\tthrow new Error(\"Connection not opened!\");\r\n\t\t}\r\n\r\n\t\tdata.type = type;\r\n\t\tdata.id = this._messageId++;\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis._pool[data.id] = {\r\n\t\t\t\tid: data.id,\r\n\t\t\t\tresolve,\r\n\t\t\t\treject,\r\n\t\t\t};\r\n\r\n\t\t\tthis._bus.postMessage(data);\r\n\t\t});\r\n\t}\r\n}\r\n","import { EVENT, PAGES } from \"./lib/API.js\";\r\n\r\nconst _BUSSES = {\r\n\t[PAGES.CONTENT]: {},\r\n\t[PAGES.DEVTOOL]: {},\r\n};\r\n\r\nlet _injectRequestId = 0;\r\n\r\n_BUSSES[PAGES.DEVTOOL].onMessage = function (message) {\r\n\tswitch (message.type) {\r\n\t\tcase EVENT.INJECT: {\r\n\t\t\tconsole.log(\"INJECT\", message.scriptToInject);\t\t\t\r\n\t\t\t_injectRequestId = message.id;\r\n\r\n\t\t\tchrome.tabs.executeScript(message.tabId, {\r\n\t\t\t\tfile: message.scriptToInject,\r\n\t\t\t});\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\tconsole.debug(\"devtool -> background\", message);\r\n};\r\n\r\n_BUSSES[PAGES.CONTENT].onMessage = function (message) {\r\n\tif(message.type === EVENT.INJECT) {\r\n\t\tmessage.id = _injectRequestId;\r\n\t\t_BUSSES[PAGES.DEVTOOL].port.postMessage(message);\r\n\t\tconsole.debug(\"content -> devtool\", message);\r\n\t}\r\n\r\n\tconsole.debug(\"content -> background\", message);\r\n};\r\n\r\n// Background page -- background.js\r\nchrome.runtime.onConnect.addListener((port) => {\r\n\t_BUSSES[port.name].port = port;\r\n\r\n\tconst onMessage = (message, sender) => {\r\n\r\n\t\tif(message.target && _BUSSES[message.target]) {\r\n\t\t\tif(!_BUSSES[message.target].port) {\r\n\t\t\t\tconsole.warn('ATTEMTS send to closed port', message);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tmessage.sender = sender.name;\r\n\t\t\t\r\n\t\t\t_BUSSES[message.target].port.postMessage(message);\r\n\t\t\tconsole.debug('proxy message to', message.target, message);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t_BUSSES[sender.name].onMessage(message);\r\n\t};\r\n\r\n\t// add the listener\r\n\tport.onMessage.addListener(onMessage);\r\n\r\n\tport.onDisconnect.addListener(() => {\r\n\t\tport.onMessage.removeListener(onMessage);\r\n\t});\r\n});\r\n"]}