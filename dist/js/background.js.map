{"version":3,"sources":["js/lib/API.ts","js/lib/EVENT.ts","js/background.ts"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAa,OAAA,CAAA,KAAA,GAAQ;AACpB,EAAA,OAAO,EAAE,cADW;AAEpB,EAAA,OAAO,EAAE;AAFW,CAAR;;AAcb,MAAa,SAAb,CAAsB;AAMrB,EAAA,WAAA,CAAmB,IAAA,GAAO,EAA1B,EAA4B;AAAT,SAAA,IAAA,GAAA,IAAA;AALT,SAAA,IAAA,GAA4B,SAA5B;AACA,SAAA,KAAA,GAA8B,EAA9B;AACA,SAAA,KAAA,GAAmD,EAAnD;AACA,SAAA,UAAA,GAAqB,CAArB;AAGT,SAAK,UAAL,GAAkB,KAAK,UAAL,CAAgB,IAAhB,CAAqB,IAArB,CAAlB;AACA;;AAED,EAAA,OAAO,CAAC,KAAK,GAAG,SAAT,EAAkB;AACxB,QAAI,KAAK,IAAT,EAAe;AACd,WAAK,IAAL,CAAU,UAAV;AACA;;AAED,QAAI,CAAC,KAAL,EAAY;AACX,WAAK,IAAL,GAAY,MAAM,CAAC,OAAP,CAAe,OAAf,CAAuB;AAAE,QAAA,IAAI,EAAE,KAAK;AAAb,OAAvB,CAAZ;AACA,KAFD,MAEO;AACN,WAAK,IAAL,GAAY,MAAM,CAAC,IAAP,CAAY,OAAZ,CAAoB,KAApB,EAA2B;AAAE,QAAA,IAAI,EAAE,KAAK;AAAb,OAA3B,CAAZ;AACA;;AAED,SAAK,IAAL,CAAU,SAAV,CAAoB,WAApB,CAAgC,KAAK,UAAL,CAAgB,IAAhB,CAAqB,IAArB,CAAhC;AACA;;AAED,EAAA,KAAK,GAAA;AACJ,SAAK,IAAL,IAAa,KAAK,IAAL,CAAU,UAAV,EAAb;AACA,SAAK,IAAL,GAAY,SAAZ;AACA;;AAED,MAAI,MAAJ,GAAU;AACT,WAAO,CAAC,CAAC,KAAK,IAAd;AACA;AAED;;;;;;;AAKA,EAAA,WAAW,CAAC,IAAD,EAAe;AACzB,IAAA,IAAI,CAAC,MAAL,GAAc,CAAC,QAAQ,GAAG,EAAZ,KAAkB;AAC/B,MAAA,QAAQ,CAAC,IAAT,GAAgB,IAAI,CAAC,IAArB;AACA,MAAA,QAAQ,CAAC,EAAT,GAAc,IAAI,CAAC,EAAnB;AACA,MAAA,QAAQ,CAAC,MAAT,GAAkB,IAAI,CAAC,MAAvB;;AACA,WAAK,IAAL,CAAU,WAAV,CAAsB,QAAtB;AACA,KALD;;AAMA,WAAO,IAAP;AACA;;AAED,EAAA,UAAU,CAAC,IAAD,EAAe;AAExB;AAEA,UAAM,QAAQ,GAAG,IAAI,CAAC,EAAL,KAAY,SAAZ,GAAwB,KAAK,KAAL,CAAW,IAAI,CAAC,EAAhB,CAAxB,GAA8C,SAA/D;;AAEA,QAAI,CAAC,QAAL,EAAe;AACd,UAAI,KAAK,KAAL,CAAW,IAAI,CAAC,IAAhB,CAAJ,EAA2B;AAC1B,aAAK,KAAL,CAAW,IAAI,CAAC,IAAhB,EAAsB,KAAK,WAAL,CAAiB,IAAjB,CAAtB,EAD0B,CAG1B;;AAEA,OALD,MAKO;AACN,QAAA,OAAO,CAAC,IAAR,CAAa,2BAAb,EAA0C,IAAI,CAAC,EAA/C,EAAmD,IAAI,CAAC,IAAxD;AACA;AACD,KATD,MASO;AACN,WAAK,KAAL,CAAW,IAAI,CAAC,EAAhB,IAAsB,SAAtB;;AACA,UAAI,IAAI,CAAC,KAAT,EAAgB;AACf,QAAA,QAAQ,CAAC,MAAT,CAAgB,IAAI,CAAC,KAArB;AACA;AACA;;AACD,MAAA,QAAQ,CAAC,OAAT,CAAiB,IAAjB;AACA;AACD;;AAED,EAAA,MAAM,CAAC,IAAD,EAAe,QAAf,EAAuD;AAC5D,SAAK,KAAL,CAAW,IAAX,IAAmB,QAAnB;AACA;;AAED,EAAA,OAAO,CAAC,IAAD,EAAa;AACnB,SAAK,KAAL,CAAW,IAAX,IAAmB,SAAnB;AACA;;AAGK,EAAA,IAAI,CAAC,IAAD,EAAe,IAAf,EAA0B,OAAO,GAAG,CAApC,EAAqC;;AAC9C,UAAI,CAAC,KAAK,IAAV,EAAgB;AACf,cAAM,IAAI,KAAJ,CAAU,wBAAV,CAAN;AACA;;AAED,MAAA,IAAI,CAAC,IAAL,GAAY,IAAZ;AACA,MAAA,IAAI,CAAC,EAAL,GAAU,IAAI,CAAC,EAAL,IAAW,KAAK,UAAL,EAArB;AAEA,aAAO,IAAI,OAAJ,CAAY,CAAC,OAAD,EAAU,MAAV,KAAoB;AACtC,aAAK,KAAL,CAAW,IAAI,CAAC,EAAhB,IAAsB;AACrB,UAAA,EAAE,EAAE,IAAI,CAAC,EADY;AAErB,UAAA,OAFqB;AAGrB,UAAA;AAHqB,SAAtB;;AAMA,YAAG,OAAO,GAAG,CAAb,EAAgB;AACf,UAAA,UAAU,CAAC,MAAI;AACd,YAAA,MAAM,CAAC,8BAAD,CAAN;AACA,WAFS,EAEP,OAFO,CAAV;AAGA;;AAED,aAAK,IAAL,CAAU,WAAV,CAAsB,IAAtB;AACA,OAdM,CAAP;AAeA;AAAA;;AAzGoB;;AAAtB,OAAA,CAAA,SAAA,GAAA,SAAA;;;;;;;ACdA,IAAkB,KAAlB;;AAAA,CAAA,UAAkB,KAAlB,EAAuB;AACtB,EAAA,KAAA,CAAA,QAAA,CAAA,GAAA,QAAA;AACA,EAAA,KAAA,CAAA,QAAA,CAAA,GAAA,QAAA;AACA,EAAA,KAAA,CAAA,MAAA,CAAA,GAAA,MAAA;AACA,EAAA,KAAA,CAAA,MAAA,CAAA,GAAA,MAAA;AACA,EAAA,KAAA,CAAA,UAAA,CAAA,GAAA,KAAA;AACA,EAAA,KAAA,CAAA,UAAA,CAAA,GAAA,UAAA;AACA,EAAA,KAAA,CAAA,UAAA,CAAA,GAAA,UAAA;AACA,EAAA,KAAA,CAAA,MAAA,CAAA,GAAA,MAAA;AACA,EAAA,KAAA,CAAA,cAAA,CAAA,GAAA,cAAA;AACA,CAVD,EAAkB,KAAK,GAAL,OAAA,CAAA,KAAA,KAAA,OAAA,CAAA,KAAA,GAAK,EAAL,CAAlB;;AAUC;;;;;;;;ACVD,MAAA,KAAA,GAAA,OAAA,CAAA,WAAA,CAAA;;AACA,MAAA,OAAA,GAAA,OAAA,CAAA,aAAA,CAAA;;AAEA,MAAM,OAAO,GAAG;AACf,GAAC,KAAA,CAAA,KAAA,CAAM,OAAP,GAAiB;AAAC,IAAA,SAAS,EAAE,SAAZ;AAAuB,IAAA,IAAI,EAAE;AAA7B,GADF;AAEf,GAAC,KAAA,CAAA,KAAA,CAAM,OAAP,GAAiB;AAAC,IAAA,SAAS,EAAE,SAAZ;AAAuB,IAAA,IAAI,EAAE;AAA7B;AAFF,CAAhB;AAKA,IAAI,gBAAgB,GAAG,CAAvB;;AAEA,OAAO,CAAC,KAAA,CAAA,KAAA,CAAM,OAAP,CAAP,CAAuB,SAAvB,GAAmC,UAAU,OAAV,EAAiB;AACnD,UAAQ,OAAO,CAAC,IAAhB;AACC,SAAK,OAAA,CAAA,KAAA,CAAM,MAAX;AAAmB;AAClB,QAAA,OAAO,CAAC,GAAR,CAAY,QAAZ,EAAsB,OAAO,CAAC,cAA9B;AACA,QAAA,gBAAgB,GAAG,OAAO,CAAC,EAA3B;AAEA,QAAA,MAAM,CAAC,IAAP,CAAY,aAAZ,CAA0B,OAAO,CAAC,KAAlC,EAAyC;AACxC,UAAA,IAAI,EAAE,OAAO,CAAC;AAD0B,SAAzC;AAGA;AACA;AATF;;AAYA,EAAA,OAAO,CAAC,KAAR,CAAc,uBAAd,EAAuC,OAAvC;AACA,CAdD;;AAgBA,OAAO,CAAC,KAAA,CAAA,KAAA,CAAM,OAAP,CAAP,CAAuB,SAAvB,GAAmC,UAAU,OAAV,EAAiB;AACnD,MAAG,OAAO,CAAC,IAAR,KAAiB,OAAA,CAAA,KAAA,CAAM,MAA1B,EAAkC;AACjC,IAAA,OAAO,CAAC,EAAR,GAAa,gBAAb;;AACA,IAAA,OAAO,CAAC,KAAA,CAAA,KAAA,CAAM,OAAP,CAAP,CAAuB,IAAvB,CAA4B,WAA5B,CAAwC,OAAxC;;AACA,IAAA,OAAO,CAAC,KAAR,CAAc,oBAAd,EAAoC,OAApC;AACA;;AAED,EAAA,OAAO,CAAC,KAAR,CAAc,uBAAd,EAAuC,OAAvC;AACA,CARD,EAUA;;;AACA,MAAM,CAAC,OAAP,CAAe,SAAf,CAAyB,WAAzB,CAAsC,IAAD,IAAS;AAC7C,EAAA,OAAO,CAAC,IAAI,CAAC,IAAN,CAAP,CAAmB,IAAnB,GAA0B,IAA1B;;AAEA,QAAM,SAAS,GAAG,CAAC,OAAD,EAAU,MAAV,KAAoB;AAErC,QAAG,OAAO,CAAC,MAAR,IAAkB,OAAO,CAAC,OAAO,CAAC,MAAT,CAA5B,EAA8C;AAC7C,UAAG,CAAC,OAAO,CAAC,OAAO,CAAC,MAAT,CAAP,CAAwB,IAA5B,EAAkC;AACjC,QAAA,OAAO,CAAC,IAAR,CAAa,6BAAb,EAA4C,OAA5C;AACA;AACA;;AAED,MAAA,OAAO,CAAC,MAAR,GAAiB,MAAM,CAAC,IAAxB;;AAEA,MAAA,OAAO,CAAC,OAAO,CAAC,MAAT,CAAP,CAAwB,IAAxB,CAA6B,WAA7B,CAAyC,OAAzC;;AACA,MAAA,OAAO,CAAC,KAAR,CAAc,kBAAd,EAAkC,OAAO,CAAC,MAA1C,EAAkD,OAAlD;AACA;AACA;;AAED,IAAA,OAAO,CAAC,MAAM,CAAC,IAAR,CAAP,CAAqB,SAArB,CAA+B,OAA/B;AACA,GAhBD,CAH6C,CAqB7C;;;AACA,EAAA,IAAI,CAAC,SAAL,CAAe,WAAf,CAA2B,SAA3B;AAEA,EAAA,IAAI,CAAC,YAAL,CAAkB,WAAlB,CAA8B,MAAK;AAClC,IAAA,IAAI,CAAC,SAAL,CAAe,cAAf,CAA8B,SAA9B;AACA,GAFD;AAGA,CA3BD","file":"background.js","sourceRoot":"..\\src","sourcesContent":["export const PAGES = {\r\n\tCONTENT: \"content-page\",\r\n\tDEVTOOL: \"devtools-page\",\r\n};\r\n\r\nexport interface IMessage {\r\n\ttarget: string;\r\n\tsender: string;\r\n\ttype: string;\r\n\terror: any;\r\n\tid: number;\r\n\tanswer?: (data: any) => void;\r\n}\r\n\r\nexport class APIServer {\r\n\tprotected _bus: chrome.runtime.Port = undefined;\r\n\tprotected _pool: {[key: string]: any} = {};\r\n\tprotected _flow: {[key: string]: (mess: IMessage) => void} = {};\r\n\tprotected _messageID: number = 0;\r\n\r\n\tconstructor(public name = '') {\r\n\t\tthis._onMessage = this._onMessage.bind(this);\r\n\t}\r\n\t\r\n\tconnect(tabId = undefined) {\r\n\t\tif (this._bus) {\r\n\t\t\tthis._bus.disconnect();\r\n\t\t}\r\n\r\n\t\tif (!tabId) {\r\n\t\t\tthis._bus = chrome.runtime.connect({ name: this.name});\r\n\t\t} else {\r\n\t\t\tthis._bus = chrome.tabs.connect(tabId, { name: this.name });\r\n\t\t}\r\n\r\n\t\tthis._bus.onMessage.addListener(this._onMessage.bind(this));\r\n\t}\r\n\r\n\tclose() {\r\n\t\tthis._bus && this._bus.disconnect();\r\n\t\tthis._bus = undefined;\r\n\t}\r\n\r\n\tget opened() {\r\n\t\treturn !!this._bus;\r\n\t}\r\n\r\n\t/**\r\n\t *\r\n\t * @param {IMessage} data\r\n\t * @returns {{answer: Function}}\r\n\t */\r\n\t_answerFlow(data: IMessage) {\r\n\t\tdata.answer = (_newData = {}) => {\r\n\t\t\t_newData.type = data.type;\r\n\t\t\t_newData.id = data.id;\r\n\t\t\t_newData.target = data.sender;\r\n\t\t\tthis._bus.postMessage(_newData);\r\n\t\t};\r\n\t\treturn data;\r\n\t}\r\n\r\n\t_onMessage(data: IMessage) {\r\n\r\n\t\t// console.debug(\"API\", this.name, data);\r\n\r\n\t\tconst resolver = data.id !== undefined ? this._pool[data.id] : undefined;\r\n\r\n\t\tif (!resolver) {\r\n\t\t\tif (this._flow[data.type]) {\r\n\t\t\t\tthis._flow[data.type](this._answerFlow(data));\r\n\r\n\t\t\t\t// console.debug(\"CAll flow\", data.type);\r\n\r\n\t\t\t} else {\r\n\t\t\t\tconsole.warn(\"message resolve not found\", data.id, data.type);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis._pool[data.id] = undefined;\r\n\t\t\tif (data.error) {\r\n\t\t\t\tresolver.reject(data.error);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tresolver.resolve(data);\r\n\t\t}\r\n\t}\r\n\r\n\tonFlow(type: string, callback: (data: IMessage & any) => void) {\r\n\t\tthis._flow[type] = callback;\r\n\t}\r\n\r\n\toffFlow(type: string) {\r\n\t\tthis._flow[type] = undefined;\r\n\t}\r\n\r\n\r\n\tasync send(type: string, data: any, timeout = 0): Promise<IMessage & any> {\r\n\t\tif (!this._bus) {\r\n\t\t\tthrow new Error(\"Connection not opened!\");\r\n\t\t}\r\n\r\n\t\tdata.type = type;\r\n\t\tdata.id = data.id || this._messageID++;\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis._pool[data.id] = {\r\n\t\t\t\tid: data.id,\r\n\t\t\t\tresolve,\r\n\t\t\t\treject,\r\n\t\t\t};\r\n\r\n\t\t\tif(timeout > 0) {\r\n\t\t\t\tsetTimeout(()=>{\r\n\t\t\t\t\treject(\"API call rejected by timeout\")\r\n\t\t\t\t}, timeout);\r\n\t\t\t}\r\n\r\n\t\t\tthis._bus.postMessage(data);\r\n\t\t});\r\n\t}\r\n}\r\n","export const enum EVENT {\r\n\tINJECT = 'inject',\r\n\tDETACH = 'detach',\r\n\tTEST = 'test',\r\n\tINFO = 'info',\r\n\tLOG_BLOB = 'log',\r\n\tLOG_INIT = 'log-init',\r\n\tLOG_STOP = 'log-stop',\r\n\tCALL = 'call',\r\n\tTRACK_BOUNDS = 'track-bounds'\r\n};\r\n","import { PAGES } from \"./lib/API\";\r\nimport {EVENT} from \"./lib/EVENT\";\r\n\r\nconst _BUSSES = {\r\n\t[PAGES.CONTENT]: {onMessage: undefined, port: undefined},\r\n\t[PAGES.DEVTOOL]: {onMessage: undefined, port: undefined},\r\n};\r\n\r\nlet _injectRequestId = 0;\r\n\r\n_BUSSES[PAGES.DEVTOOL].onMessage = function (message) {\r\n\tswitch (message.type) {\r\n\t\tcase EVENT.INJECT: {\r\n\t\t\tconsole.log(\"INJECT\", message.scriptToInject);\t\t\t\r\n\t\t\t_injectRequestId = message.id;\r\n\r\n\t\t\tchrome.tabs.executeScript(message.tabId, {\r\n\t\t\t\tfile: message.scriptToInject,\r\n\t\t\t});\r\n\t\t\tbreak;\r\n\t\t}\r\n\t}\r\n\r\n\tconsole.debug(\"devtool -> background\", message);\r\n};\r\n\r\n_BUSSES[PAGES.CONTENT].onMessage = function (message) {\r\n\tif(message.type === EVENT.INJECT) {\r\n\t\tmessage.id = _injectRequestId;\r\n\t\t_BUSSES[PAGES.DEVTOOL].port.postMessage(message);\r\n\t\tconsole.debug(\"content -> devtool\", message);\r\n\t}\r\n\r\n\tconsole.debug(\"content -> background\", message);\r\n};\r\n\r\n// Background page -- background.js\r\nchrome.runtime.onConnect.addListener((port) => {\r\n\t_BUSSES[port.name].port = port;\r\n\r\n\tconst onMessage = (message, sender) => {\r\n\r\n\t\tif(message.target && _BUSSES[message.target]) {\r\n\t\t\tif(!_BUSSES[message.target].port) {\r\n\t\t\t\tconsole.warn('ATTEMTS send to closed port', message);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tmessage.sender = sender.name;\r\n\t\t\t\r\n\t\t\t_BUSSES[message.target].port.postMessage(message);\r\n\t\t\tconsole.debug('proxy message to', message.target, message);\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t_BUSSES[sender.name].onMessage(message);\r\n\t};\r\n\r\n\t// add the listener\r\n\tport.onMessage.addListener(onMessage);\r\n\r\n\tport.onDisconnect.addListener(() => {\r\n\t\tport.onMessage.removeListener(onMessage);\r\n\t});\r\n});\r\n"]}