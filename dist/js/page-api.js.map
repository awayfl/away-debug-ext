{"version":3,"sources":["js/page-api.js"],"names":["APIServer","constructor","_pool","_messageId","_onMessage","bind","_flow","connect","window","addEventListener","close","removeEventListener","data","from","resolver","id","undefined","type","_answerFlow","console","warn","error","reject","resolve","onFlow","callback","offFlow","answer","_newData","target","sender","postMessage","send","Promise","api","BATCH_BLOB_TIME","BATCH_BLOBS","WAIT_TIMEOUT","AWAY_DEBUG","_limit","_total","_logBlob","_logBathedSender","_lastLoggedValue","_detachLogger","reason","registerWriter","clearTimeout","_sendLog","blob","length","waiter","setTimeout","total","then","e","_logWriter","str","push","testOnDebug","_AWAY_DEBUG_","debug","status","logInit","logType","limit","allow","logStop"],"mappings":"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","file":"page-api.js","sourceRoot":"..\\src","sourcesContent":["(function () {\r\n\tclass APIServer {\r\n\t\tconstructor() {\r\n\t\t\tthis._pool = {};\r\n\t\t\tthis._messageId = 0;\r\n\t\t\tthis._onMessage = this._onMessage.bind(this);\r\n\t\t\tthis._flow = {};\r\n\t\t\tthis.connect();\r\n\t\t}\r\n\r\n\t\tconnect() {\r\n\t\t\twindow.addEventListener(\"message\", this._onMessage);\r\n\t\t}\r\n\r\n\t\tclose() {\r\n\t\t\twindow.removeEventListener(\"message\", this._onMessage);\r\n\t\t}\r\n\r\n\t\t_onMessage({ data }) {\r\n\t\t\tif (data.from !== \"_AWAY_PROXY_event\") {\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\tconst resolver = this._pool[data.id];\r\n\t\t\tthis._pool[data.id] = undefined;\r\n\r\n\t\t\tif (!resolver) {\r\n\t\t\t\tif (this._flow[data.type]) {\r\n\t\t\t\t\tthis._flow[data.type](this._answerFlow(data));\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.warn(\r\n\t\t\t\t\t\t\"message resolve not found\",\r\n\t\t\t\t\t\tdata.id,\r\n\t\t\t\t\t\tdata.type\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\tif (data.error) {\r\n\t\t\t\t\tresolver.reject(data.error);\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\t\t\t\tresolver.resolve(data);\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\tonFlow(type, callback) {\r\n\t\t\tthis._flow[type] = callback;\r\n\t\t}\r\n\r\n\t\toffFlow(type) {\r\n\t\t\tthis._flow[type] = false;\r\n\t\t}\r\n\r\n\t\t/**\r\n\t\t *\r\n\t\t * @param {any} data\r\n\t\t * @returns {{answer: Function}}\r\n\t\t */\r\n\t\t_answerFlow(data) {\r\n\t\t\tdata.answer = (_newData = {}) => {\r\n\t\t\t\t_newData.type = data.type;\r\n\t\t\t\t_newData.id = data.id;\r\n\t\t\t\t_newData.from = \"_AWAY_API_event\";\r\n\t\t\t\t_newData.target = data.sender;\r\n\t\t\t\twindow.postMessage(_newData, \"*\");\r\n\t\t\t};\r\n\t\t\treturn data;\r\n\t\t}\r\n\r\n\t\tasync send(type, data = {}) {\r\n\t\t\tdata.type = type;\r\n\t\t\tdata.id = data.id || this._messageId++;\r\n\t\t\tdata.from = \"_AWAY_API_event\";\r\n\r\n\t\t\treturn new Promise((resolve, reject) => {\r\n\t\t\t\tthis._pool[data.id] = {\r\n\t\t\t\t\tid: data.id,\r\n\t\t\t\t\tresolve,\r\n\t\t\t\t\treject,\r\n\t\t\t\t};\r\n\t\t\t\twindow.postMessage(data, \"*\");\r\n\t\t\t});\r\n\t\t}\r\n\t}\r\n\r\n\t// ---------------main -------------\r\n\tconst api = new APIServer();\r\n\r\n\tconst BATCH_BLOB_TIME = 500;\r\n\tconst BATCH_BLOBS = 1000;\r\n\tconst WAIT_TIMEOUT = 1000;\r\n\t/**\r\n\t * @type {IAwayDebug}\r\n\t */\r\n\tlet AWAY_DEBUG = undefined;\r\n\tlet _limit = 500000;\r\n\tlet _total = 0;\r\n\tlet _logBlob = [];\r\n\tlet _logBathedSender = undefined;\r\n\tlet _lastLoggedValue = undefined;\r\n\r\n\tfunction _detachLogger(reason) {\r\n\t\tAWAY_DEBUG.registerWriter(0, null);\r\n\r\n\t\tclearTimeout(_logBathedSender);\r\n\r\n\t\tapi.send(\"log-stop\", { target: \"devtools-page\", reason });\r\n\t}\r\n\r\n\tfunction _sendLog(blob) {\r\n\t\tif(!blob.length) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst waiter = setTimeout(() => {\r\n\t\t\t_detachLogger(\"timeout\");\r\n\t\t}, WAIT_TIMEOUT);\r\n\t\t\r\n\t\t// send blobs and wait, or stop sending!\r\n\t\tapi.send(\"log\", { blob, target: \"devtools-page\", total: _total }).then(\r\n\t\t\t(e) => {\r\n\t\t\t\tclearTimeout(waiter);\r\n\t\t\t}\r\n\t\t);\r\n\t}\r\n\r\n\tfunction _logWriter(str) {\r\n\t\tif(str !== _lastLoggedValue){\r\n\t\t\t_logBlob.push(str);\r\n\t\t\t_total++;\r\n\r\n\t\t\t_lastLoggedValue = str;\r\n\t\t}\r\n\r\n\t\tif (!_logBathedSender) {\r\n\t\t\t_logBathedSender = setTimeout(() => {\r\n\t\t\t\t_sendLog(_logBlob);\r\n\t\t\t\t_logBlob = [];\r\n\t\t\t\t_logBathedSender = undefined;\r\n\t\t\t}, BATCH_BLOB_TIME);\r\n\t\t}\r\n\r\n\t\tif (_logBlob.length >= BATCH_BLOBS) {\r\n\t\t\t_sendLog(_logBlob);\r\n\t\t\t_logBlob = [];\r\n\r\n\t\t\tclearTimeout(_logBathedSender);\r\n\t\t\t_logBathedSender = undefined;\r\n\t\t}\r\n\r\n\t\tif (_total > _limit) {\r\n\t\t\t_detachLogger(\"limit\");\r\n\t\t}\r\n\t}\r\n\r\n\tfunction testOnDebug({ answer }) {\r\n\t\tif(!AWAY_DEBUG && window._AWAY_DEBUG_){\r\n\t\t\tconsole.debug(\"AWAY_API attached\");\r\n\t\t}\r\n\r\n\t\tAWAY_DEBUG = window._AWAY_DEBUG_;\r\n\r\n\t\tanswer({ status: !!AWAY_DEBUG });\r\n\t}\r\n\r\n\tfunction logInit({ answer, logType, limit }) {\r\n\t\t_limit = limit;\r\n\t\t_total = 0;\r\n\r\n\t\tAWAY_DEBUG.registerWriter(logType, _logWriter);\r\n\t\tanswer({allow: true});\r\n\t}\r\n\r\n\tfunction logStop() {\r\n\t\t_detachLogger(\"manual\");\r\n\t}\r\n\r\n\tapi.onFlow(\"test\", testOnDebug);\r\n\tapi.onFlow(\"log-init\", logInit);\r\n\tapi.onFlow(\"log-stop\", logStop);\r\n\t///\r\n})();\r\n"]}