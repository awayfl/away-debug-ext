{"version":3,"sources":["js/lib/API.ts","js/lib/PageAPI.ts","js/lib/EVENT.ts","js/bbox.ts","js/page-api.ts"],"names":[],"mappings":"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","file":"page-api.js","sourceRoot":"..\\src","sourcesContent":["export const PAGES = {\r\n\tCONTENT: \"content-page\",\r\n\tDEVTOOL: \"devtools-page\",\r\n};\r\n\r\nexport interface IMessage {\r\n\ttarget: string;\r\n\tsender: string;\r\n\ttype: string;\r\n\terror: any;\r\n\tid: number;\r\n\tanswer?: (data: any) => void;\r\n}\r\n\r\nexport class APIServer {\r\n\tprotected _bus: chrome.runtime.Port = undefined;\r\n\tprotected _pool: {[key: string]: any} = {};\r\n\tprotected _flow: {[key: string]: (mess: IMessage) => void} = {};\r\n\tprotected _messageID: number = 0;\r\n\r\n\tconstructor(public name = '') {\r\n\t\tthis._onMessage = this._onMessage.bind(this);\r\n\t}\r\n\t\r\n\tconnect(tabId = undefined) {\r\n\t\tif (this._bus) {\r\n\t\t\tthis._bus.disconnect();\r\n\t\t}\r\n\r\n\t\tif (!tabId) {\r\n\t\t\tthis._bus = chrome.runtime.connect({ name: this.name});\r\n\t\t} else {\r\n\t\t\tthis._bus = chrome.tabs.connect(tabId, { name: this.name });\r\n\t\t}\r\n\r\n\t\tthis._bus.onMessage.addListener(this._onMessage.bind(this));\r\n\t}\r\n\r\n\tclose() {\r\n\t\tthis._bus && this._bus.disconnect();\r\n\t\tthis._bus = undefined;\r\n\t}\r\n\r\n\tget opened() {\r\n\t\treturn !!this._bus;\r\n\t}\r\n\r\n\t/**\r\n\t *\r\n\t * @param {IMessage} data\r\n\t * @returns {{answer: Function}}\r\n\t */\r\n\t_answerFlow(data: IMessage) {\r\n\t\tdata.answer = (_newData = {}) => {\r\n\t\t\t_newData.type = data.type;\r\n\t\t\t_newData.id = data.id;\r\n\t\t\t_newData.target = data.sender;\r\n\t\t\tthis._bus.postMessage(_newData);\r\n\t\t};\r\n\t\treturn data;\r\n\t}\r\n\r\n\t_onMessage(data: IMessage) {\r\n\r\n\t\t// console.debug(\"API\", this.name, data);\r\n\r\n\t\tconst resolver = data.id !== undefined ? this._pool[data.id] : undefined;\r\n\r\n\t\tif (!resolver) {\r\n\t\t\tif (this._flow[data.type]) {\r\n\t\t\t\tthis._flow[data.type](this._answerFlow(data));\r\n\r\n\t\t\t\t// console.debug(\"CAll flow\", data.type);\r\n\r\n\t\t\t} else {\r\n\t\t\t\tconsole.warn(\"message resolve not found\", data.id, data.type);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tthis._pool[data.id] = undefined;\r\n\t\t\tif (data.error) {\r\n\t\t\t\tresolver.reject(data.error);\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\t\t\tresolver.resolve(data);\r\n\t\t}\r\n\t}\r\n\r\n\tonFlow(type: string, callback: (data: IMessage & any) => void) {\r\n\t\tthis._flow[type] = callback;\r\n\t}\r\n\r\n\toffFlow(type: string) {\r\n\t\tthis._flow[type] = undefined;\r\n\t}\r\n\r\n\r\n\tasync send(type: string, data: any, timeout = 0): Promise<IMessage & any> {\r\n\t\tif (!this._bus) {\r\n\t\t\tthrow new Error(\"Connection not opened!\");\r\n\t\t}\r\n\r\n\t\tdata.type = type;\r\n\t\tdata.id = data.id || this._messageID++;\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis._pool[data.id] = {\r\n\t\t\t\tid: data.id,\r\n\t\t\t\tresolve,\r\n\t\t\t\treject,\r\n\t\t\t};\r\n\r\n\t\t\tif(timeout > 0) {\r\n\t\t\t\tsetTimeout(()=>{\r\n\t\t\t\t\treject(\"API call rejected by timeout\")\r\n\t\t\t\t}, timeout);\r\n\t\t\t}\r\n\r\n\t\t\tthis._bus.postMessage(data);\r\n\t\t});\r\n\t}\r\n}\r\n","import {APIServer, IMessage} from \"./API\"\r\n\r\nexport const enum PAGE_MARKER {\r\n\tPROXY = \"_AWAY_API_event\",\r\n\tPAGE = \"_AWAY_PAGE_event\"\r\n}\r\n\r\ninterface IPageMessage extends IMessage {\r\n\tfrom: PAGE_MARKER;\r\n}\r\n\r\nexport class APIPage extends APIServer {\r\n\tconstructor() {\r\n\t\tsuper(\"page\");\r\n\t\tthis._bus = <any>{};\r\n\t\tthis.connect();\r\n\t}\r\n\r\n\tconnect() {\r\n\t\twindow.addEventListener(\"message\", this._onMessage);\r\n\t}\r\n\r\n\tclose() {\r\n\t\twindow.removeEventListener(\"message\", this._onMessage);\r\n\t}\r\n\r\n\t// @ts-ignore\r\n\t_onMessage(message: any) {\r\n\t\tif (message.data.from !== PAGE_MARKER.PROXY) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// console.debug(\"PAGE API\", message.data);\r\n\r\n\t\tsuper._onMessage(message.data);\r\n\t}\r\n\r\n\t_answerFlow(data: IPageMessage) {\r\n\t\tdata.answer = (_newData = {}) => {\r\n\t\t\t_newData.type = data.type;\r\n\t\t\t_newData.id = data.id;\r\n\t\t\t_newData.from = PAGE_MARKER.PAGE;\r\n\t\t\t_newData.target = data.sender;\r\n\t\t\twindow.postMessage(_newData, \"*\");\r\n\t\t};\r\n\t\treturn data;\r\n\t}\r\n\r\n\tasync send(type: string, data: any = {}): Promise<IPageMessage & any> {\r\n\t\tdata.type = type;\r\n\t\tdata.id = data.id || this._messageID++;\r\n\t\tdata.from = PAGE_MARKER.PAGE;\r\n\r\n\t\treturn new Promise((resolve, reject) => {\r\n\t\t\tthis._pool[data.id] = {\r\n\t\t\t\tid: data.id,\r\n\t\t\t\tresolve,\r\n\t\t\t\treject,\r\n\t\t\t};\r\n\t\t\twindow.postMessage(data, \"*\");\r\n\t\t});\r\n\t}\r\n}","export const enum EVENT {\r\n\tINJECT = 'inject',\r\n\tDETACH = 'detach',\r\n\tTEST = 'test',\r\n\tINFO = 'info',\r\n\tLOG_BLOB = 'log',\r\n\tLOG_INIT = 'log-init',\r\n\tLOG_STOP = 'log-stop',\r\n\tCALL = 'call',\r\n\tTRACK_BOUNDS = 'track-bounds'\r\n};\r\n","export interface INode {\r\n\tid: number;\r\n\trect: {\r\n\t\tx: number;\r\n\t\ty: number;\r\n\t\twidth: number;\r\n\t\theight: number;\r\n\t};\r\n\tvisible: boolean;\r\n\tglobalVisible: boolean;\r\n\tselected?: boolean;\r\n\tname: string;\r\n\tcolor?: string;\r\n\tchildren: INode[];\r\n}\r\n\r\nexport class BboxRenderer {\r\n\toptions = {\r\n\t\tdrawNames: true,\r\n\t\tthinkness: 2,\r\n\t\tdefaultColor: \"#00ff00\"\r\n\t};\r\n\r\n\tnodeRequiestMethod: () => Array<INode>;\r\n\r\n\tfollow: Element;\r\n\tcanvas: HTMLCanvasElement;\r\n\tctx: CanvasRenderingContext2D;\r\n\tloop: boolean = false;\r\n\r\n\tinit(follow: Element, request: () => Array<INode>, options = {}) {\r\n\t\tconst canvas: HTMLCanvasElement =\r\n\t\t\tdocument.querySelector(\"#__AWAY__DEBUG__CANVAS__\") ||\r\n\t\t\tdocument.createElement(\"canvas\");\r\n\r\n\t\tcanvas.setAttribute(\"id\", \"__AWAY__DEBUG__CANVAS__\");\r\n\r\n\t\tObject.assign(canvas.style, {\r\n\t\t\tposition: \"absolute\",\r\n\t\t\tpointerEvents: \"none\",\r\n\t\t\tzIndex: 1000,\r\n\t\t});\r\n\r\n\t\tthis.options = Object.assign({\r\n\t\t\tdrawNames: true,\r\n\t\t\tthinkness: 2,\r\n\t\t\tdefaultColor: \"#00ff00\"\r\n\t\t}, options);\r\n\r\n\t\tthis.canvas = canvas;\r\n\t\tthis.ctx = canvas.getContext('2d');\r\n\r\n\t\tthis.follow = follow;\r\n\t\tthis.follow.parentElement.appendChild(this.canvas);\r\n\t\tthis.resize();\r\n\r\n\t\tthis.nodeRequiestMethod = request;\r\n\r\n\t\tthis.redraw = this.redraw.bind(this);\r\n\t\tthis.redraw();\r\n\t}\r\n\r\n\tdrawNode(node: INode) {\r\n\t\tconst ctx = this.ctx;\r\n\r\n\t\tif(!node.rect || !node.visible) {\r\n\t\t\treturn;\r\n\t\t}\r\n\t\tif (node.color) {\r\n\t\t\tctx.strokeStyle = node.color;\r\n\t\t}\r\n\r\n\t\tif (node.selected) {\r\n\t\t\tctx.lineWidth = this.options.thinkness * 2;\r\n\t\t}\r\n\r\n\t\tconst { x, y, width, height } = node.rect;\r\n\r\n\t\tctx.strokeRect(x, y, width, height);\r\n\r\n\t\tif (this.options.drawNames) {\r\n\t\t\tctx.fillText(\r\n\t\t\t\t`${node.name}, ${node.id}`,\r\n\t\t\t\tx + 4,\r\n\t\t\t\ty + 16,\r\n\t\t\t\twidth - 4\r\n\t\t\t);\r\n\t\t}\r\n\r\n\t\tif (node.color) {\r\n\t\t\tctx.strokeStyle = this.options.defaultColor;\r\n\t\t}\r\n\r\n\t\tif (node.selected) {\r\n\t\t\tctx.lineWidth = this.options.thinkness;\r\n\t\t}\r\n\r\n\t\tif(node.children && node.children.length > 0) {\r\n\t\t\tfor(const c of node.children)\r\n\t\t\t\tthis.drawNode(c);\r\n\t\t}\r\n\t}\r\n\r\n\tredraw() {\r\n\t\tif (!this.canvas) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.resize();\r\n\t\tconst nodes = this.nodeRequiestMethod();\r\n\t\tconst ctx = this.ctx;\r\n\r\n\t\tctx.clearRect(0, 0, this.canvas.width, this.canvas.height);\r\n\t\tctx.lineWidth = this.options.thinkness;\r\n\t\tctx.strokeStyle = this.options.defaultColor;\r\n\t\tctx.fillStyle = this.options.defaultColor;\r\n\t\tctx.font = \"12px sans\";\r\n\r\n\t\tfor (const node of nodes) {\r\n\t\t\tthis.drawNode(node);\r\n\t\t}\r\n\r\n\t\trequestAnimationFrame(this.redraw);\r\n\t}\r\n\r\n\tresize() {\r\n\t\tconst rect = this.follow.getBoundingClientRect();\r\n\r\n\t\tthis.canvas.width = rect.width;\r\n\t\tthis.canvas.height = rect.height;\r\n\r\n\t\tObject.assign(this.canvas.style, {\r\n\t\t\ttop: rect.y + \"px\",\r\n\t\t\tleft: rect.x + \"px\",\r\n\t\t\twidth: rect.width + \"px\",\r\n\t\t\theight: rect.height + \"px\",\r\n\t\t});\r\n\t}\r\n\r\n\tdispose() {\r\n\t\tif (!this.canvas) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tthis.canvas.remove();\r\n\t\tthis.canvas = null;\r\n\t\tthis.ctx = null;\r\n\t}\r\n}\r\n\r\n\r\n//@ts-ignore\r\nwindow.BBOX_RENDERE = BboxRenderer;","import { APIPage } from \"./lib/PageAPI\";\r\nimport { EVENT } from \"./lib/EVENT\";\r\nimport { BboxRenderer } from \"./bbox\";\r\n\r\ndeclare global {\r\n\tinterface Window {\r\n\t\t_AWAY_DEBUG_: IAwayDebug;\r\n\t}\r\n}\r\n\r\n(function () {\r\n\tconsole.debug(\"PAGE API INJECTED\");\r\n\r\n\t// ---------------main -------------\r\n\tconst api = new APIPage();\r\n\tconst bbox = new BboxRenderer();\r\n\r\n\tconst BATCH_BLOB_TIME = 500;\r\n\tconst BATCH_BLOBS = 1000;\r\n\tconst WAIT_TIMEOUT = 1000;\r\n\t/**\r\n\t * @type {IAwayDebug}\r\n\t */\r\n\tlet AWAY_DEBUG = undefined;\r\n\tlet _limit = 500000;\r\n\tlet _total = 0;\r\n\tlet _logBlob = [];\r\n\tlet _logBathedSender = undefined;\r\n\tlet _lastLoggedValue = undefined;\r\n\r\n\tfunction safeCall(method: string, args: any[]) {\r\n\t\tif (!AWAY_DEBUG) {\r\n\t\t\tthrow \"[AWAY DEBUG PAGE API] AWAY DEBUG interface not found!\";\r\n\t\t}\r\n\r\n\t\tif (typeof AWAY_DEBUG[method] !== \"function\") {\r\n\t\t\tthrow `[AWAY DEBUG PAGE API] field ${method} not callable!`;\r\n\t\t}\r\n\r\n\t\treturn AWAY_DEBUG[method].apply(undefined, args);\r\n\t}\r\n\r\n\tfunction _detachLogger(reason: string) {\r\n\t\tAWAY_DEBUG.registerWriter(0, null);\r\n\r\n\t\tclearTimeout(_logBathedSender);\r\n\r\n\t\tapi.send(EVENT.LOG_STOP, { target: \"devtools-page\", reason });\r\n\t}\r\n\r\n\tfunction _sendLog(blob: string[]) {\r\n\t\tif (!blob.length) {\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst waiter = setTimeout(() => {\r\n\t\t\t_detachLogger(\"timeout\");\r\n\t\t}, WAIT_TIMEOUT);\r\n\r\n\t\t// send blobs and wait, or stop sending!\r\n\t\tapi.send(EVENT.LOG_BLOB, {\r\n\t\t\tblob,\r\n\t\t\ttarget: \"devtools-page\",\r\n\t\t\ttotal: _total,\r\n\t\t}).then((e) => {\r\n\t\t\tclearTimeout(waiter);\r\n\t\t});\r\n\t}\r\n\r\n\tfunction _logWriter(str: string) {\r\n\t\tif (str !== _lastLoggedValue) {\r\n\t\t\t_logBlob.push(str);\r\n\t\t\t_total++;\r\n\r\n\t\t\t_lastLoggedValue = str;\r\n\t\t}\r\n\r\n\t\tif (!_logBathedSender) {\r\n\t\t\t_logBathedSender = setTimeout(() => {\r\n\t\t\t\t_sendLog(_logBlob);\r\n\t\t\t\t_logBlob = [];\r\n\t\t\t\t_logBathedSender = undefined;\r\n\t\t\t}, BATCH_BLOB_TIME);\r\n\t\t}\r\n\r\n\t\tif (_logBlob.length >= BATCH_BLOBS) {\r\n\t\t\t_sendLog(_logBlob);\r\n\t\t\t_logBlob = [];\r\n\r\n\t\t\tclearTimeout(_logBathedSender);\r\n\t\t\t_logBathedSender = undefined;\r\n\t\t}\r\n\r\n\t\tif (_total > _limit) {\r\n\t\t\t_detachLogger(\"limit\");\r\n\t\t}\r\n\t}\r\n\r\n\tfunction logInit({ answer, logType, limit }) {\r\n\t\t_limit = limit;\r\n\t\t_total = 0;\r\n\r\n\t\tsafeCall(\"registerWriter\", [logType, _logWriter]);\r\n\r\n\t\tanswer({ allow: true });\r\n\t}\r\n\r\n\tfunction logStop() {\r\n\t\t_detachLogger(\"manual\");\r\n\t}\r\n\r\n\tfunction testOnDebug({ answer }) {\r\n\t\tif (!AWAY_DEBUG && window._AWAY_DEBUG_) {\r\n\t\t\tconsole.debug(\"AWAY_API attached\");\r\n\t\t}\r\n\r\n\t\tAWAY_DEBUG = window._AWAY_DEBUG_;\r\n\r\n\t\tanswer({ status: !!AWAY_DEBUG });\r\n\t}\r\n\r\n\tfunction directCall({ answer, method, args = [] }) {\r\n\t\ttry {\r\n\t\t\tconst data = safeCall(method, args);\r\n\r\n\t\t\tif (data && typeof data.then === \"function\") {\r\n\t\t\t\tdata.then((result) => {\r\n\t\t\t\t\tanswer({ result });\r\n\t\t\t\t});\r\n\t\t\t} else {\r\n\t\t\t\tanswer({ result: data });\r\n\t\t\t}\r\n\t\t} catch (e) {\r\n\t\t\tanswer({ error: e });\r\n\t\t}\r\n\t}\r\n\r\n\tfunction trackBounds({ answer, method, args }) {\r\n\r\n\t\tif(!AWAY_DEBUG.getStageCanvas) {\r\n\t\t\treturn answer ({error: \"Bounds debugger not exist on this AWAY Player version.\"});\r\n\t\t}\r\n\r\n\t\tswitch (method) {\r\n\t\t\tcase \"init\": {\r\n\t\t\t\tconst canvas = AWAY_DEBUG.getStageCanvas();\r\n\r\n\t\t\t\tif (!canvas) {\r\n\t\t\t\t\treturn answer({ error: \"Unknow stage!\" });\r\n\t\t\t\t}\r\n\r\n\t\t\t\tconst request = () => AWAY_DEBUG.getNodeTree({flat: false, from: 0, rect: true, visibleOnly:true});\r\n\t\t\t\tbbox.init(canvas, request, args);\r\n\r\n\t\t\t\treturn answer({ ok: true });\r\n\t\t\t}\r\n\r\n\t\t\tcase \"dispose\": {\r\n\t\t\t\tbbox.dispose();\r\n\t\t\t\tanswer({ ok: true });\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tapi.onFlow(EVENT.DETACH, function () {\r\n\t\tbbox.dispose();\r\n\t});\r\n\tapi.onFlow(EVENT.TEST, testOnDebug);\r\n\tapi.onFlow(EVENT.LOG_INIT, logInit);\r\n\tapi.onFlow(EVENT.LOG_STOP, logStop);\r\n\tapi.onFlow(EVENT.CALL, directCall);\r\n\tapi.onFlow(EVENT.TRACK_BOUNDS, trackBounds);\r\n\r\n\t///\r\n})();\r\n"]}